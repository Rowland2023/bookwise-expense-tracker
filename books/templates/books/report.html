<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ðŸ“˜ Book Expense Report</title>

    <!-- ðŸ”¹ STEP 4.1: Include Chart.js and jsPDF Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <!-- ðŸ”¹ STEP 4.2: Add Basic Styling -->
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 40px;
            background: #f5f7fa;
        }
        h1 {
            margin-bottom: 25px;
            color: #222;
        }
        .chart-container {
            max-width: 750px;
            margin: 0 auto 30px auto; /* Center the chart container */
            padding: 20px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .buttons {
            text-align: center; /* Center the buttons */
            margin-top: 20px;
        }
        button {
            padding: 10px 20px;
            margin: 0 5px; /* Adjust margin for centering */
            background-color: #4285f4;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 4px;
            font-size: 16px;
            transition: background-color 0.3s ease;
        }
        button:hover {
            background-color: #357ae8;
        }
    </style>
</head>
<body>

    <!-- ðŸ”¹ STEP 4.3: Report Title -->
    <h1>Book Expense Breakdown by Month</h1>

    <!-- ðŸ”¹ STEP 4.4: Load Expense Data from Django Context -->
    <!-- IMPORTANT: The json_script filter itself generates the <script> tag.
         Do NOT wrap it in another <script> tag. -->
    {{ labels|json_script:"chart-labels" }}
    {{ totals|json_script:"chart-totals" }}

    <!-- ðŸ”¹ STEP 4.5: Chart Container -->
    <div class="chart-container">
        <canvas id="expenseChart" width="700" height="400"></canvas>
    </div>

    <!-- ðŸ”¹ STEP 4.6: Action Buttons (Image + PDF Export) -->
    <div class="buttons">
        <button id="downloadChartBtn">Download Chart as Image</button>
        <button id="exportPdfBtn">Export Chart as PDF</button>
    </div>

    <!-- ðŸ”¹ STEP 4.7: Chart Configuration + Export Logic -->
    <script>
        let expenseChart; // Declare expenseChart in a broader scope

        document.addEventListener('DOMContentLoaded', function() {
            // Parse labels and totals data from JSON
            // These now correctly target the IDs generated by json_script
            const labels = JSON.parse(document.getElementById('chart-labels').textContent);
            const amounts = JSON.parse(document.getElementById('chart-totals').textContent);

            // Chart configuration
            const config = {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Amount (â‚¦)',
                        data: amounts,
                        backgroundColor: 'rgba(54, 162, 235, 0.6)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Total Expenses by Month'
                        },
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            };

            // Render the chart
            const ctx = document.getElementById('expenseChart').getContext('2d');
            expenseChart = new Chart(ctx, config); // Assign to the broader scoped variable

            // Attach event listeners after chart is initialized
            document.getElementById('downloadChartBtn').addEventListener('click', downloadChart);
            document.getElementById('exportPdfBtn').addEventListener('click', exportPDF);
        });

        // ðŸ”¸ Export Chart as PNG
        function downloadChart() {
            if (expenseChart) { // Check if chart is initialized
                const image = expenseChart.toBase64Image();
                const link = document.createElement('a');
                link.href = image;
                link.download = 'book_expense_chart.png';
                link.click();
            } else {
                console.error("Chart not initialized for download.");
            }
        }

        // ðŸ”¸ Export Chart as PDF
        function exportPDF() {
            if (expenseChart) { // Check if chart is initialized
                // Check if jspdf is loaded correctly
                if (typeof jspdf === 'undefined' || !jspdf.jsPDF) {
                    console.error("jsPDF library not loaded. Cannot export to PDF.");
                    alert("PDF export not available. Please check console for errors.");
                    return;
                }
                const canvas = document.getElementById('expenseChart');
                const imgData = canvas.toDataURL('image/png');
                const pdf = new jspdf.jsPDF();
                pdf.addImage(imgData, 'PNG', 15, 30, 170, 90);
                pdf.save('book_expense_report.pdf');
            } else {
                console.error("Chart not initialized for PDF export.");
            }
        }
    </script>
</body>
</html>